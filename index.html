<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.js'></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.css' rel='stylesheet' />
    <style>
      body {
        margin: 0;
        padding: 0;
      }

      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
	  
	  
	          .ol-geocoder.gcd-gl-container {
            top: 65px!important;
        }
        .ol-geocoder .gcd-gl-btn {
            width: 21px!important;
            height: 21px!important;
        }
		
		@media (max-width: 600px) {
			#myImage {
			  display: none;
			}
			#myImageMobile {
			  display: inline-flex;
			}	
		}
	  
	   @media (min-width: 600px) {
			#myImageMobile {
			  display: none;
			}
			#myImage {
			  display: inline-flex;
			}
		}
		
		@media (max-width: 600px) {
			#myTitle {
			  display: none;
			}
			#myImageMobile {
			  display: inline-flex;
			}	
		}
	  
	   @media (min-width: 600px) {
			#myTitleMobile {
			  display: none;
			}
			#myImage {
			  display: inline-flex;
			}
		}
    </style>
	<title>מחירי דיור לפי שנים</title>
</head>
<body>
  <div id='map'>
  			<h2 style="text-align: center" id ="myTitle">מחירי דיור למ"ר בשנים 2006 עד 2018</h2>
			<h3 style="text-align: center" id ="myTitleMobile">מחירי דיור למ"ר בשנים 2006 עד 2018</h3>
								<div style="position: relative;">
					<div id="slider_div" dir="rtl" style="width: 300px; position: absolute;
											text-align: center;
											align: center;
											margin:0;
											overflow: hidden;
											background:white;
											border: 1px solid #ff3366;
											border-color: black;
											z-index:1;
											float:center;
											right:2px;">
											
						<input type="range" min="2006" max="2018" value="2018" style="width: 200px;" id="myRange">
						<label id="demo" style="float:left; margin-left:20px; margin-top:5px;">2018</label>
						</div>
					<div id="combo_div"style="width: 300px; position: absolute; z-index:1;top: 30px; right: 2px;">
					<select id="select" onchange="myFunctionSetl()" dir="rtl"  style="width: 200px;">
						<option value="שם ישוב" >שם ישוב</option>
					</select>
					<select id="select1" onchange="myFunctionNeigh()" dir="rtl"  style="width: 200px; right:2px;">
						<option value="שם שכונה" >שם שכונה</option>
					</select>
					 </div>
					 </div>
  
  </div>
  <script>
  	var slider = document.getElementById("myRange");
	var output = document.getElementById("demo");
	var features;
  
  
    mapboxgl.accessToken = 'pk.eyJ1IjoieW92YXZzYW5kZXJzIiwiYSI6ImNqcGF4c2lveDJpNWszcXJ3a2wyNDBxNTcifQ.0tGpMLNldd3iKdaJy0qV8Q';
    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/dark-v9',
      center: [34.78,32.06],
      zoom: 11
    });	
	
	map.on('style.load', function() {
		
			  map.addSource('2018', {
			type: 'geojson',
			data: './Deals_2018.geojson'
		  });
		  
		  map.addSource('2017', {
			type: 'geojson',
			data: './Deals_2017.geojson'
		  });
		  
		   map.addSource('2016', {
			type: 'geojson',
			data: './Deals_2016.geojson'
		  });
		  
		  map.addSource('2015', {
			type: 'geojson',
			data: './Deals_2015.geojson'
		  });
		  
		  map.addSource('2014', {
			type: 'geojson',
			data: './Deals_2014.geojson'
		  });
		  
		  map.addSource('2013', {
			type: 'geojson',
			data: './Deals_2013.geojson'
		  });
		  
		  map.addSource('2012', {
			type: 'geojson',
			data: './Deals_2012.geojson'
		  });
		  
		  map.addSource('2011', {
			type: 'geojson',
			data: './Deals_2011.geojson'
		  });
		  
		  map.addSource('2010', {
			type: 'geojson',
			data: './Deals_2010.geojson'
		  });
		  
		  map.addSource('2009', {
			type: 'geojson',
			data: './Deals_2009.geojson'
		  });
		  map.addSource('2008', {
			type: 'geojson',
			data: './Deals_2008.geojson'
		  });
		  map.addSource('2007', {
			type: 'geojson',
			data: './Deals_2007.geojson'
		  });
		  map.addSource('2006', {
			type: 'geojson',
			data: './Deals_2006.geojson'
		  });
		  
		  map.addSource('NEIGHBORHOODs_Area', {
			type: 'geojson',
			data: './NEIGHBORHOODs_Area.geojson'
		  });
		  
		  

		
		addLayer("2018");

		

	});
	
	
		function addLayer(year){
			if (map.getLayer("deals-heat")){
				map.removeLayer("deals-heat");
			}
			if (map.getLayer("deals-point")){
				map.removeLayer("deals-point");
			}
			if (map.getLayer("neighborhoods")){
				map.removeLayer("neighborhoods");
			}
			if (map.getLayer("label")){
				map.removeLayer("label");
			}
			
			map.addLayer({
			'id': 'neighborhoods',
			'type': 'fill',
			'source': "NEIGHBORHOODs_Area",
			'layout': {},
			'paint': {
				'fill-color': 'white',
				'fill-opacity':0.2,
				'fill-outline-color' :"yellow"
				//"line-color": "#888",
				//"line-width": 8
				}
			});
			map.addLayer({
			'id': 'label',
			'type': 'symbol',
			'source': "NEIGHBORHOODs_Area",
			'layout': {
				'symbol-placement': 'point',
				'text-field': '{FNAME_REV}',
				'text-anchor': 'bottom',
				'symbol-spacing': 1
			},
			'paint': {
				}
			});
			
		  
			map.addLayer({
			id: 'deals-heat',
			type: 'heatmap',
			source: year,
			maxzoom: 24,
			paint: {
			// increase weight as diameter breast height increases
			'heatmap-weight': {
			  property: 'stats_MEAN',
			  type: 'exponential',
			  stops: [
				[1, 0],
				[30000, 1]
			  ]
			},
			// increase intensity as zoom level increases
			'heatmap-intensity': {
			  stops: [
				[11, 1],
				[15, 3]
			  ]
			},
			// assign color values be applied to points depending on their density
			'heatmap-color': [
			  'interpolate',
			  ['linear'],
			  ['heatmap-density'],
				0, "rgba(33,102,172,0)",
				0.2, "rgb(103,169,207)",
				0.4, "rgb(209,229,240)",
				0.6, "rgb(253,219,199)",
				0.95, "rgb(239,138,98)",
				1, "rgb(178,24,43)"
			],
			// increase radius as zoom increases
			'heatmap-radius': {
			  stops: [
				[11, 15],
				[15, 20]
			  ]
			},
			// decrease opacity to transition into the circle layer
			'heatmap-opacity': {
			  default: 1,
			  stops: [
				[14, 1],
				[15, 0]
			  ]
			},
			}
			}, 'waterway-label');



			  map.addLayer({
			"id": "deals-point",
			"type": "circle",
			"source": year,
			"minzoom": 14,
			"paint": {
			// Size circle radius by earthquake magnitude and zoom level
			"circle-radius": [
				"interpolate",
				["linear"],
				["zoom"],
				14, [
					"interpolate",
					["linear"],
					["get", "stats_MEAN"],
					1, 1,
					94000, 8
				],
				24, [
					"interpolate",
					["linear"],
					["get", "stats_MEAN"],
					1, 9,
					94000, 20
				]
			],
			// Color circle by earthquake magnitude
			"circle-color": [
				"interpolate",
				["linear"],
				["get", "stats_MEAN"],
				1000, "rgba(33,102,172,0)",
				11000, "rgb(103,169,207)",
				17000, "rgb(209,229,240)",
				26000, "rgb(253,219,199)",
				44000, "rgb(239,138,98)",
				94000, "rgb(178,24,43)"
			],
			"circle-stroke-color": "white",
			"circle-stroke-width": 0.5,
			// Transition from heatmap to circle layer by zoom level
			"circle-opacity": [
				"interpolate",
				["linear"],
				["zoom"],
				6, 0,
				24, 1
			]
			}
			}, 'waterway-label');


			map.on('click', 'deals-point', function(e) {
			new mapboxgl.Popup()
			.setLngLat(e.features[0].geometry.coordinates)
			.setHTML('<b>מחיר למ"ר: </b> ' + e.features[0].properties.stats_MEAN.toLocaleString() + ' ש"ח')
			.addTo(map);
			});
			
			// Change the cursor to a pointer when the mouse is over the states layer.
			map.on('mouseenter', 'deals-point', function () {
				map.getCanvas().style.cursor = 'pointer';
			});

			// Change it back to a pointer when it leaves.
			map.on('mouseleave', 'deals-point', function () {
				map.getCanvas().style.cursor = '';
			});
			
			$.getJSON('./NEIGHBORHOODs_Area.geojson', function(features1) {
				features = features1.features;
				var x = document.getElementById("select");
				var x1 = document.getElementById("select1");
				var setl_names = [];
				for (i = 0; i < features.length; i++)
				{
					//console.log(features[i].properties.SETL_NAME);
					if (!isInArray(features[i].properties.SETL_NAME, setl_names))
					{
						setl_names.push(features[i].properties.SETL_NAME);	
					}
					setl_names.sort();
					

				}
				//console.log(setl_names);
				for (i = 0; i < setl_names .length; i++)
				{
						var option = document.createElement("option");
						option.text = setl_names[i];
						x.add(option);
				}
				var neigh_names = [];
				var counter = 0;
			});
			//data is the JSON string
			
			//var features =NEIGHBORHOODs_Area.features;
			
			
			
	}
	
	
	slider.oninput = function() {
				output.innerHTML = this.value;
				addLayer(this.value);
	}
	
	
	

		

	function myFunctionSetl() {
		var x_list =[];
		var y_list =[];
		var selected_setl = document.getElementById("select").value;
		if (selected_setl != "שם ישוב")
		{
			//console.log(selected_setl);
			$.getJSON('./NEIGHBORHOODs_Area.geojson', function(features1) {
				var features = features1.features.filter(function(item) {
					return item.properties.SETL_NAME.indexOf(selected_setl) > -1;
				});
				for (i = 0; i < features.length; i++)
				{
					var feat = features[i].geometry.coordinates;
					for (p = 0; p < feat.length; p++)
					{
						part = feat[p];
						for (c = 0; c < part.length; c++)
						{
							coordinates = part[c];
							x_list.push(coordinates[0]);
							y_list.push(coordinates[1]);		
						}
					}
				}
				max_x = Math.max.apply(null, x_list);
				max_y = Math.max.apply(null, y_list);
				min_x = Math.min.apply(null, x_list);
				min_y = Math.min.apply(null, y_list);
				
				var bbox = [[max_x, max_y], [min_x, min_y]];
				map.fitBounds(bbox, {
				  padding: {top: 10, bottom:25, left: 15, right: 5}
				});
				mid_x = min_x + ((max_x - min_x) / 2);
				mid_y = min_y + ((max_y - min_y) / 2);
				//console.log([mid_x, mid_y]);
				//map.setCenter([mid_x, mid_y]);
				
				neigh_names = [];
				for (i = 0; i < features.length; i++)
				{
					if (!isInArray(features[i].properties.FNAME, neigh_names) && features[i].properties.SETL_NAME == selected_setl && features[i].properties.FNAME != 'null')
					{
						//console.log(features[i].properties.FNAME);
						neigh_names.push(features[i].properties.FNAME);
					}
				}
				neigh_names.sort();
				var x1 = document.getElementById("select1");
				x1.innerHTML = "";
				var option = document.createElement("option");
				option.text = "שם שכונה";
				x1.add(option);
				for (i = 0; i < neigh_names.length; i++)
				{
					var option = document.createElement("option");
					option.text = neigh_names[i];
					x1.add(option);
				}
			});
			
			
		}	
	}
	
	
	function myFunctionNeigh() {
		var x_list =[];
		var y_list =[];
		var x = document.getElementById("select1").value;
		//console.log(x);
		//zoom to neigh_name
		var selected_setl = document.getElementById("select").value;
		
		console.log(selected_setl);
		$.getJSON('./NEIGHBORHOODs_Area.geojson', function(features1) {
			var features = features1.features.filter(function(item) {
				return item.properties.SETL_NAME.indexOf(selected_setl) > -1;
			});
			//var features = NEIGHBORHOODs_Area.features
			for (i = 0; i < features.length; i++)
			{
				if (features[i].properties.FNAME == x && features[i].properties.SETL_NAME == document.getElementById("select").value )
				{
					var feat = features[i].geometry.coordinates;
					for (p = 0; p < feat.length; p++)
					{
						part = feat[p];
						for (c = 0; c < part.length; c++)
						{
							coordinates = part[c];
							x_list.push(coordinates[0]);
							y_list.push(coordinates[1]);		
						}
					}		
				}
			}
			max_x = Math.max.apply(null, x_list);
			max_y = Math.max.apply(null, y_list);
			min_x = Math.min.apply(null, x_list);
			min_y = Math.min.apply(null, y_list);
			
			var bbox = [[max_x, max_y], [min_x, min_y]];
			map.fitBounds(bbox, 
			{
			  padding: {top: 10, bottom:25, left: 15, right: 5}
			});		
		});
	}
	
	
	function isInArray(value, array) {
		return array.indexOf(value) > -1;
	}
	
	Array.prototype.max = function() {
	  return Math.max.apply(null, this);
	};

	Array.prototype.min = function() {
	  return Math.min.apply(null, this);
	};

   // we will add more code here in the next steps

  </script>
</body>
</html>
